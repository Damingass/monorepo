# Spritesheet生成功能使用指南

## 功能概述

序列帧播放器现在支持将多张图片拼合成spritesheet（精灵图表）。这个功能可以将序列帧中的图片按指定的行列数排列，生成一张包含所有帧的大图。

## 使用方法

### 1. 添加图片到序列帧

首先，从图像预览区域将图片添加到序列帧：

- **单图模式**：点击底部指示器的下拉菜单 → 选择"添加到序列帧"
- **多图模式**：选中多张图片 → 点击"添加选中到序列帧"

### 2. 设置spritesheet参数

在序列帧播放器下方的"生成Spritesheet"区域：

- **行 (n)**：设置spritesheet的行数（1-20）
- **列 (m)**：设置spritesheet的列数（1-20）

例如：
- `2行 × 3列` = 6个格子
- `4行 × 4列` = 16个格子

### 3. 生成spritesheet

点击"生成 (n×m)"按钮，系统会：

1. 加载序列帧中的所有图片
2. 按照指定的行列数排列图片
3. 拼合成一张大图
4. 自动保存并添加到图像预览列表

### 4. 使用生成的spritesheet

生成的spritesheet会自动添加到图像预览列表顶部，你可以：

- 在预览区查看完整的spritesheet
- 点击"导入到PS"按钮，将spritesheet导入到Photoshop图层
- 像其他图片一样对其进行操作

## 功能特点

### 保持原始分辨率 ⭐

- **不会降低图片分辨率**：使用原图（url）而不是缩略图（thumbnail_url）
- 使用第一张图片的**原始尺寸**作为每个单元格的尺寸
- 所有图片都会被调整到相同大小
- 最终尺寸 = `列数 × 单元格宽度` × `行数 × 单元格高度`

**示例：**
- 原图尺寸：1024×1024像素
- 布局：2行×2列
- 最终spritesheet：**2048×2048像素**（保持原始分辨率）

### 智能提示

- 如果图片数量少于格子数量，剩余格子将保持空白
- 如果图片数量多于格子数量，会显示警告，只使用前n×m张图片

### 示例

**示例1：标准尺寸**

假设你有8张图片，每张512×512像素：

**设置 2×4（8个格子）：**
```
单元格尺寸: 512×512像素（原始）
最终尺寸: 2048×1024像素 (4×512 × 2×512)
布局：
[图1] [图2] [图3] [图4]
[图5] [图6] [图7] [图8]
```

**示例2：高分辨率**

假设你有4张图片，每张1024×1024像素：

**设置 2×2（4个格子）：**
```
单元格尺寸: 1024×1024像素（原始）
最终尺寸: 2048×2048像素 (2×1024 × 2×1024)
布局：
[图1] [图2]
[图3] [图4]
```
**✨ 关键：保持原始分辨率，不会因为拼合而降低清晰度！**

**示例3：多余格子**

假设你有8张图片，设置3×3（9个格子）：
```
单元格尺寸: 512×512像素
最终尺寸: 1536×1536像素 (3×512 × 3×512)
布局：
[图1] [图2] [图3]
[图4] [图5] [图6]
[图7] [图8] [空白]
```

## 常见用途

### 游戏开发

将角色动画帧拼合成spritesheet，用于游戏引擎：

- 行走动画：1行×8列
- 多方向动画：4行×4列（每行一个方向）

### UI资源

将多个UI元素拼合成一张图：

- 按钮状态：1行×3列（正常/悬停/按下）
- 图标集合：4行×8列（32个图标）

### 动画序列

将连续的动画帧合并：

- 爆炸效果：3行×3列（9帧）
- 加载动画：1行×12列（12帧）

## 技术细节

### 图片加载和处理

- **使用原图**：从 `url` 字段加载图片（不是 `thumbnail_url`）
- **保持分辨率**：使用第一张图片的原始宽度和高度
- **Canvas绘制**：使用 `drawImage()` 以原始尺寸绘制，不进行缩放

### 图片排列顺序

图片按从左到右、从上到下的顺序排列：

```
1  2  3  4
5  6  7  8
9  10 11 12
```

### 图片格式

- 输出格式：PNG（支持透明度）
- 编码方式：Base64 data URL
- 保存位置：永久存储（通过 `downloadImage`），可重复使用
- 最终添加到预览列表，可导入到PS

### 性能考虑

- **推荐配置**：
  - 单元格尺寸：512×512 到 2048×2048像素
  - 总格子数：不超过100个（如10×10）
  - 最终文件大小：取决于内容，PNG格式

- **高分辨率场景**：
  - 4K图片（3840×2160）：建议不超过2×2布局
  - 8K图片（7680×4320）：建议单张或1×2布局
  - 生成过程中会显示加载状态

- **内存考虑**：
  - 每张图片加载到内存中
  - Canvas尺寸 = 行数×列数×单元格尺寸
  - 例：4张2K图(2048×2048) → 2×2布局 → 4096×4096 canvas

## 控制台日志

生成过程中会输出详细日志，帮助你了解生成过程：

```
[Spritesheet] 图片 0 加载完成，尺寸: 1024×1024
[Spritesheet] 图片 1 加载完成，尺寸: 1024×1024
[Spritesheet] 图片 2 加载完成，尺寸: 1024×1024
[Spritesheet] 图片 3 加载完成，尺寸: 1024×1024
[Spritesheet] 成功加载了 4 张图片
[Spritesheet] 单元格尺寸（原始分辨率）: 1024 x 1024
[Spritesheet] Canvas总尺寸（原始分辨率）: 2048 x 2048
[Spritesheet] 说明：每个单元格 1024 x 1024 | 布局 2 x 2
[Spritesheet] 绘制图片 0: 原始尺寸 1024×1024 → 位置 (0, 0)
[Spritesheet] 绘制图片 1: 原始尺寸 1024×1024 → 位置 (1024, 0)
[Spritesheet] 绘制图片 2: 原始尺寸 1024×1024 → 位置 (0, 1024)
[Spritesheet] 绘制图片 3: 原始尺寸 1024×1024 → 位置 (1024, 1024)
[Spritesheet] 生成完成！
[Spritesheet] - 最终尺寸: 2048 x 2048 像素
[Spritesheet] - 文件大小: 1245.67 KB
[Spritesheet] - 单元格尺寸: 1024 x 1024
[Spritesheet] - 布局: 2 行 x 2 列 = 4 个格子
[Spritesheet] downloadImage 返回结果: {...}
[Spritesheet] 获得永久路径: {...}
[Spritesheet] Spritesheet已成功添加到预览列表
```

**日志说明：**
- 每张图片加载时显示其原始尺寸
- 最终canvas尺寸 = 单元格尺寸 × 布局
- 每张图片绘制时显示原始尺寸和位置
- 生成完成后显示完整统计信息

## 注意事项

1. **图片尺寸一致性** ⚠️：
   - 第一张图片的**原始尺寸**将作为所有单元格的尺寸
   - 其他图片会被缩放到相同尺寸（可能拉伸或压缩）
   - **强烈建议**序列帧中的图片尺寸保持一致，以避免变形
   - 如果图片尺寸不一致，可能会出现拉伸或压缩的效果

2. **内存使用**：
   - 大尺寸或大量图片会占用较多内存
   - 如遇到卡顿，尝试减少图片数量或降低分辨率

3. **透明度支持**：
   - PNG格式完整保留透明度
   - 空白格子将保持透明

4. **保存位置**：
   - 生成的spritesheet会永久保存
   - 存储在本地下载目录
   - 可以重复导入到PS

## 快捷工作流

### 从PS图层快速生成spritesheet

1. 在PS中准备好多个图层（每个图层是一帧）
2. 在插件中点击"从图层导入" × N次（导入每一帧）
3. 在单图或多图模式下，将所有图片添加到序列帧
4. 设置合适的行列数
5. 点击"生成"
6. 将生成的spritesheet导入回PS

### 从ComfyUI输出生成spritesheet

1. 使用ComfyUI批量生成图片
2. 图片自动添加到预览列表
3. 全选图片 → 添加到序列帧
4. 设置行列数 → 生成spritesheet
5. 导入回PS进行后期处理

## 相关文件

- `packages/sdppp-photoshop/src/tsx/components/SequencePlayer.tsx` - 主要实现
- `packages/sdppp-photoshop/src/tsx/components/SequencePlayer.less` - 样式
- `packages/sdppp-photoshop/src/tsx/components/ImagePreviewWrapper.tsx` - 集成和回调处理

## 更新日期

2025-10-23


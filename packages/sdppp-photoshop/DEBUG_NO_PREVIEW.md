# "No Preview" é—®é¢˜è°ƒè¯•æŒ‡å—

## ğŸ” é—®é¢˜ç—‡çŠ¶

PS å›¾å±‚å¯¼å…¥åæ˜¾ç¤º "no preview"

---

## ğŸ“‹ è°ƒè¯•æ—¥å¿—æ£€æŸ¥æ¸…å•

è¯·æŒ‰ç…§ä»¥ä¸‹é¡ºåºæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼Œé€æ­¥å®šä½é—®é¢˜ï¼š

### ç¬¬1æ­¥ï¼šæ£€æŸ¥ getImage è¿”å›æ•°æ®

```
[å›¾å±‚å¯¼å…¥] === getImage è¿”å›å®Œæ•´æ•°æ®åˆ†æ ===
[å›¾å±‚å¯¼å…¥] thumbnail_urlç±»å‹: ?
[å›¾å±‚å¯¼å…¥] sourceè·¯å¾„: ?
[å›¾å±‚å¯¼å…¥] widthÃ—height: ? Ã— ?
```

**é¢„æœŸ**:
- `sourceè·¯å¾„` åº”è¯¥æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ–‡ä»¶è·¯å¾„ï¼Œå¦‚ `C:/Users/.../Temp/xxx.png`
- `widthÃ—height` åº”è¯¥æ˜¯å›¾å±‚çš„å®é™…å°ºå¯¸ï¼Œå¦‚ `1024 Ã— 1024`

**å¦‚æœå¼‚å¸¸**:
- âŒ `sourceè·¯å¾„: undefined` â†’ getImage æ²¡æœ‰è¿”å› source
- âŒ `widthÃ—height: undefined Ã— undefined` â†’ getImage æ²¡æœ‰è¿”å›å°ºå¯¸

---

### ç¬¬2æ­¥ï¼šæ£€æŸ¥æ–¹æ¡ˆé€‰æ‹©

```
[å›¾å±‚å¯¼å…¥] === å†³ç­–ï¼šä½¿ç”¨å“ªä¸ªæ•°æ®æºï¼Ÿ ===
[å›¾å±‚å¯¼å…¥] sourceUrlæ˜¯å¦å­˜åœ¨: ?
[å›¾å±‚å¯¼å…¥] thumbnailUrlæ˜¯å¦å­˜åœ¨: ?
[å›¾å±‚å¯¼å…¥] sourceUrlå€¼: ?
```

**é¢„æœŸ**:
- `sourceUrlæ˜¯å¦å­˜åœ¨: true`
- `sourceUrlå€¼:` åº”è¯¥æ˜¯å®Œæ•´çš„æ–‡ä»¶è·¯å¾„

**å¦‚æœå¼‚å¸¸**:
- âŒ `sourceUrlæ˜¯å¦å­˜åœ¨: false` â†’ æ²¡æœ‰ sourceï¼Œä¼šä½¿ç”¨æ–¹æ¡ˆ2ï¼ˆä½åˆ†è¾¨ç‡ï¼‰

---

### ç¬¬3æ­¥ï¼šæ£€æŸ¥æ‰§è¡Œçš„æ–¹æ¡ˆ

```
[å›¾å±‚å¯¼å…¥] === æ–¹æ¡ˆé€‰æ‹© ===
[å›¾å±‚å¯¼å…¥] å°†è¦æ‰§è¡Œçš„æ–¹æ¡ˆ: ?
```

**é¢„æœŸ**:
- `æ–¹æ¡ˆ1ï¼ˆsourceï¼‰`

**å¦‚æœå¼‚å¸¸**:
- âŒ `æ–¹æ¡ˆ2ï¼ˆthumbnailUrlï¼‰` â†’ ä½¿ç”¨äº†ä½åˆ†è¾¨ç‡ data URL
- âŒ `é”™è¯¯ï¼šéƒ½ä¸å­˜åœ¨` â†’ æ—¢æ²¡æœ‰ source ä¹Ÿæ²¡æœ‰ thumbnail_url

---

### ç¬¬4æ­¥ï¼šæ£€æŸ¥æ–¹æ¡ˆ1çš„æ‰§è¡Œï¼ˆå¦‚æœä½¿ç”¨æ–¹æ¡ˆ1ï¼‰

```
[å›¾å±‚å¯¼å…¥] âœ… æ–¹æ¡ˆ1ï¼šç›´æ¥ä½¿ç”¨ source æ–‡ä»¶ï¼ˆå®Œæ•´åˆ†è¾¨ç‡ï¼‰
[å›¾å±‚å¯¼å…¥] sourceè·¯å¾„: ?
[å›¾å±‚å¯¼å…¥] æ¸…ç†åçš„nativePath: ?
[å›¾å±‚å¯¼å…¥] ç”ŸæˆdisplayUrlï¼ˆç”¨äºé¢„è§ˆï¼ŒæŒ‡å‘åŒä¸€æ–‡ä»¶ï¼‰: ?
```

**é¢„æœŸ**:
- `sourceè·¯å¾„:` å®Œæ•´æ–‡ä»¶è·¯å¾„
- `æ¸…ç†åçš„nativePath:` å»é™¤ `file://` å‰ç¼€çš„çº¯è·¯å¾„
- `ç”ŸæˆdisplayUrl:` `file:///C:/Users/.../xxx.png` æ ¼å¼

**å¦‚æœå¼‚å¸¸**:
- âŒ `displayUrl` æ ¼å¼ä¸æ­£ç¡®
- âŒ è·¯å¾„åŒ…å«ç‰¹æ®Šå­—ç¬¦æˆ–ç©ºæ ¼æ²¡æœ‰æ­£ç¡®è½¬ä¹‰

---

### ç¬¬5æ­¥ï¼šæ£€æŸ¥ä¿å­˜åˆ° store å‰çš„æ•°æ®

```
[å›¾å±‚å¯¼å…¥] === ä¿å­˜åˆ°storeå‰çš„æ•°æ®æ£€æŸ¥ ===
[å›¾å±‚å¯¼å…¥] url: ?
[å›¾å±‚å¯¼å…¥] urlç±»å‹: ?
[å›¾å±‚å¯¼å…¥] urlæ˜¯å¦ä»¥file://å¼€å¤´: ?
[å›¾å±‚å¯¼å…¥] thumbnail_url: ?
[å›¾å±‚å¯¼å…¥] thumbnail_urlç±»å‹: ?
[å›¾å±‚å¯¼å…¥] thumbnail_url === url: ?
[å›¾å±‚å¯¼å…¥] nativePath: ?
[å›¾å±‚å¯¼å…¥] width Ã— height: ?
```

**é¢„æœŸ**:
- `url:` `file:///C:/Users/.../xxx.png`
- `urlç±»å‹: string`
- `urlæ˜¯å¦ä»¥file://å¼€å¤´: true`
- `thumbnail_url:` åº”è¯¥å’Œ `url` ç›¸åŒ
- `thumbnail_url === url: true`
- `nativePath:` `C:/Users/.../xxx.png`ï¼ˆçº¯è·¯å¾„ï¼Œæ—  file://ï¼‰
- `width Ã— height: 1024 Ã— 1024`ï¼ˆå®Œæ•´åˆ†è¾¨ç‡ï¼‰

**å¦‚æœå¼‚å¸¸**:
- âŒ `url: undefined` â†’ displayUrl æ²¡æœ‰è¢«è®¾ç½®
- âŒ `urlç±»å‹: undefined` â†’ url æ˜¯ undefined
- âŒ `thumbnail_url: undefined` â†’ thumbnail_url æ²¡æœ‰è¢«è®¾ç½®
- âŒ `width Ã— height: 0 Ã— 0` â†’ å°ºå¯¸ä¸¢å¤±

---

### ç¬¬6æ­¥ï¼šæ£€æŸ¥ store ä¸­çš„æ•°æ®

```
[å›¾å±‚å¯¼å…¥] === éªŒè¯storeä¸­çš„æ•°æ® ===
[å›¾å±‚å¯¼å…¥] storeä¸­çš„url: ?
[å›¾å±‚å¯¼å…¥] storeä¸­çš„thumbnail_url: ?
[å›¾å±‚å¯¼å…¥] storeä¸­çš„nativePath: ?
```

**é¢„æœŸ**:
- åº”è¯¥å’Œç¬¬5æ­¥ä¿å­˜çš„æ•°æ®ä¸€è‡´

**å¦‚æœå¼‚å¸¸**:
- âŒ æ•°æ®å’Œç¬¬5æ­¥ä¸ä¸€è‡´ â†’ store è®¾ç½®æœ‰é—®é¢˜
- âŒ æŸäº›å­—æ®µå˜æˆäº† undefined â†’ æ•°æ®åœ¨ä¿å­˜è¿‡ç¨‹ä¸­ä¸¢å¤±

---

### ç¬¬7æ­¥ï¼šæ£€æŸ¥ useMemo å¤„ç†

```
[ImagePreviewWrapper] useMemoå¤„ç†æœ€æ–°PSå›¾å±‚å¯¼å…¥: {
  åŸå§‹url: ?
  åŸå§‹thumbnail_url: ?
  åŸå§‹nativePath: ?
  å¤„ç†åthumbnail_url: ?
  æ˜¯å¦æœ‰thumbnail_url: ?
  æ˜¯å¦æœ‰url: ?
}
```

**é¢„æœŸ**:
- `åŸå§‹url:` `file:///C:/Users/.../xxx.png...`
- `åŸå§‹thumbnail_url:` `file:///C:/Users/.../xxx.png...`
- `å¤„ç†åthumbnail_url:` `file:///C:/Users/.../xxx.png...`
- `æ˜¯å¦æœ‰thumbnail_url: true`
- `æ˜¯å¦æœ‰url: true`

**å¦‚æœå¼‚å¸¸**:
- âŒ `æ˜¯å¦æœ‰thumbnail_url: false` â†’ thumbnail_url ä¸¢å¤±
- âŒ `å¤„ç†åthumbnail_url` ä¸æ˜¯ file:// æ ¼å¼ â†’ å›é€€é€»è¾‘æœ‰é—®é¢˜

---

### ç¬¬8æ­¥ï¼šæ£€æŸ¥ ImagePreview ç»„ä»¶

```
[ImagePreview] å½“å‰å›¾åƒæ•°æ®: {
  index: ?
  url: ?
  thumbnail_url: ?
  nativePath: ?
  source: ?
  æ˜¯å¦æœ‰thumbnail_url: ?
  æ˜¯å¦æœ‰url: ?
  downloading: ?
}
```

**é¢„æœŸ**:
- `url:` `file:///C:/Users/.../xxx.png...`
- `thumbnail_url:` `file:///C:/Users/.../xxx.png...`
- `æ˜¯å¦æœ‰thumbnail_url: true`
- `æ˜¯å¦æœ‰url: true`
- `downloading: false`

**å¦‚æœå¼‚å¸¸**:
- âŒ `æ˜¯å¦æœ‰thumbnail_url: false` â†’ ImagePreview ä¼šæ˜¾ç¤ºç©º divï¼ˆ"no preview"ï¼‰
- âŒ `thumbnail_url: undefined` â†’ è¿™æ˜¯æ ¹æœ¬åŸå› 

---

## ğŸ¯ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šsourceUrl ä¸º undefined

**åŸå› **: getImage æ²¡æœ‰è¿”å› source æˆ– file_token

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ PS ç‰ˆæœ¬å’Œ SDK ç‰ˆæœ¬æ˜¯å¦å…¼å®¹
2. ç¡®è®¤å›¾å±‚æ˜¯å¯è§ä¸”éç©ºçš„
3. å°è¯•ä½¿ç”¨æ–¹æ¡ˆ2ï¼ˆè™½ç„¶ä¼šé™åˆ†è¾¨ç‡ï¼‰

### é—®é¢˜2ï¼šdisplayUrl æ ¼å¼é”™è¯¯

**åŸå› **: è·¯å¾„æ¸…ç†æˆ–æ ¼å¼åŒ–é€»è¾‘æœ‰è¯¯

**æ£€æŸ¥**:
```typescript
// åº”è¯¥æ˜¯ï¼šfile:///C:/Users/xxx/xxx.png
// ä¸åº”è¯¥æ˜¯ï¼šfile://C:/Users/xxx/xxx.png ï¼ˆå°‘ä¸€ä¸ªæ–œæ ï¼‰
// ä¸åº”è¯¥æ˜¯ï¼šC:/Users/xxx/xxx.png ï¼ˆæ²¡æœ‰åè®®ï¼‰
```

### é—®é¢˜3ï¼šthumbnail_url åœ¨ä¼ é€’è¿‡ç¨‹ä¸­ä¸¢å¤±

**åŸå› **: 
- å¯èƒ½æ˜¯ç©ºå­—ç¬¦ä¸²ï¼ˆ''ï¼‰è€Œä¸æ˜¯ undefined
- ç©ºå­—ç¬¦ä¸²åœ¨å¸ƒå°”æ£€æŸ¥æ—¶æ˜¯å‡å€¼

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥æ˜¯å¦æœ‰åœ°æ–¹å°† undefined è½¬æ¢æˆäº†ç©ºå­—ç¬¦ä¸²
- åœ¨ useMemo ä¸­ä½¿ç”¨æ›´å¼ºçš„æ£€æŸ¥ï¼š`!img.thumbnail_url` è€Œä¸æ˜¯ `img.thumbnail_url || img.url`

### é—®é¢˜4ï¼šæ–‡ä»¶è·¯å¾„åŒ…å«ç‰¹æ®Šå­—ç¬¦

**åŸå› **: æ–‡ä»¶è·¯å¾„åŒ…å«ç©ºæ ¼ã€ä¸­æ–‡æˆ–ç‰¹æ®Šå­—ç¬¦ï¼Œæ²¡æœ‰æ­£ç¡®ç¼–ç 

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// ç”Ÿæˆ displayUrl æ—¶è¿›è¡Œ URL ç¼–ç 
const normalizedPath = nativePath.replace(/\\/g, '/');
const encodedPath = normalizedPath.split('/').map(encodeURIComponent).join('/');
displayUrl = `file:///${encodedPath}`;
```

---

## ğŸ”§ ç´§æ€¥ä¿®å¤æ–¹æ¡ˆ

å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œå¯ä»¥å°è¯•ä»¥ä¸‹ç´§æ€¥ä¿®å¤ï¼š

### ä¿®å¤1ï¼šå¼ºåˆ¶ä½¿ç”¨ data URL

```typescript
// åœ¨æ–¹æ¡ˆ1ä¸­ï¼ŒåŒæ—¶ä¿å­˜ data URL ä½œä¸ºå›é€€
const newImage = {
  url: displayUrl,                    // file:// URL
  thumbnail_url: thumbnailUrl,        // data URLï¼ˆä½åˆ†è¾¨ç‡ä½†ç¡®ä¿èƒ½æ˜¾ç¤ºï¼‰
  nativePath: nativePath,             // çº¯è·¯å¾„ï¼ˆç”¨äºå¯¼å…¥PSï¼‰
  // ...
};
```

**æƒè¡¡**:
- âœ… é¢„è§ˆèƒ½å¤Ÿæ˜¾ç¤ºï¼ˆè™½ç„¶æ˜¯ä½åˆ†è¾¨ç‡ï¼‰
- âŒ é¢„è§ˆæ˜¯ 192Ã—192 ç¼©ç•¥å›¾
- âœ… å¯¼å…¥åˆ° PS ä»ç„¶æ˜¯å®Œæ•´åˆ†è¾¨ç‡ï¼ˆå› ä¸ºä½¿ç”¨ nativePathï¼‰

### ä¿®å¤2ï¼šä½¿ç”¨ downloadImage å¤åˆ¶æ–‡ä»¶

```typescript
// ä½¿ç”¨ downloadImage å°† source å¤åˆ¶åˆ°æ°¸ä¹…ä½ç½®
const fileUrl = `file:///${sourceUrl.replace(/\\/g, '/')}`;
try {
  const result = await downloadImage({ url: fileUrl });
  if (!('error' in result) && result.nativePath) {
    // ä½¿ç”¨ downloadImage è¿”å›çš„æ°¸ä¹…è·¯å¾„
    nativePath = result.nativePath;
    displayUrl = `file:///${nativePath.replace(/\\/g, '/')}`;
  }
} catch (e) {
  // å›é€€åˆ°ç›´æ¥ä½¿ç”¨ source
}
```

**æƒè¡¡**:
- âœ… è·å¾—æ°¸ä¹…æ–‡ä»¶
- âŒ å¯èƒ½ä¼šé™é‡‡æ ·ï¼ˆéœ€è¦æµ‹è¯•ï¼‰
- âŒ å¤šä¸€æ¬¡æ–‡ä»¶å¤åˆ¶æ“ä½œ

---

## ğŸ“ éœ€è¦åé¦ˆçš„ä¿¡æ¯

å¦‚æœé—®é¢˜ä»ç„¶æ— æ³•è§£å†³ï¼Œè¯·æä¾›ä»¥ä¸‹æ—¥å¿—ä¿¡æ¯ï¼š

1. **å®Œæ•´çš„æ§åˆ¶å°æ—¥å¿—**ï¼ˆä» `[å›¾å±‚å¯¼å…¥] å¼€å§‹å¯¼å…¥æµç¨‹` åˆ° `[ImagePreview] å½“å‰å›¾åƒæ•°æ®`ï¼‰
2. **PS ç‰ˆæœ¬**
3. **å›¾å±‚ç±»å‹**ï¼ˆæ™®é€šå›¾å±‚ã€æ™ºèƒ½å¯¹è±¡ç­‰ï¼‰
4. **å›¾å±‚å°ºå¯¸**
5. **æ˜¯å¦æœ‰æŠ¥é”™ä¿¡æ¯**

---

## ğŸ‰ æˆåŠŸçš„æ ‡å¿—

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
[å›¾å±‚å¯¼å…¥] âœ… æ–¹æ¡ˆ1å®Œæˆï¼Œè·³è¿‡downloadImage
[å›¾å±‚å¯¼å…¥] âœ… åˆ†è¾¨ç‡ä¿æŒä¸€è‡´: 1024Ã—1024åƒç´ 
[ImagePreviewWrapper] useMemoå¤„ç†æœ€æ–°PSå›¾å±‚å¯¼å…¥: {
  æ˜¯å¦æœ‰thumbnail_url: true
}
[ImagePreview] å½“å‰å›¾åƒæ•°æ®: {
  æ˜¯å¦æœ‰thumbnail_url: true
}
```

å¹¶ä¸”ï¼š
- âœ… é¢„è§ˆåŒºåŸŸæ˜¾ç¤ºå›¾åƒï¼ˆä¸æ˜¯ "no preview"ï¼‰
- âœ… å›¾åƒæ¸…æ™°ï¼Œå’Œ PS å›¾å±‚ä¸€è‡´
- âœ… å¯ä»¥é‡å¤å¯¼å…¥åˆ° PSï¼Œä¿æŒå®Œæ•´åˆ†è¾¨ç‡


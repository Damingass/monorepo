# @sdppp/common i18n 国际化系统

## 概述

本文档记录了 SDPPP 项目中统一的国际化（i18n）系统的架构设计和使用方法。该系统于 2024-08-31 完成重构，采用基于技术栈的分层架构设计。

## 重构历程

### 重构前的问题
- 多个 i18n 文件散布在不同位置（`i18n.ts`, `i18n_next.ts`, `i18n_uxp.ts`, `i18n_antd.ts`, `i18n_utils.ts`）
- 翻译资源格式不统一（JSON + TypeScript 对象混用）
- 按运行环境区分 API（UXP vs 非UXP），导致概念混乱
- 缺乏类型安全保障
- 依赖关系复杂，维护困难

### 重构后的改进
- **统一架构**：按技术栈分层（React vs Vanilla JavaScript）
- **类型安全**：全部迁移到 TypeScript，提供完整的编译时类型检查
- **统一资源**：所有环境共享同一套翻译键值和资源文件
- **清晰分工**：React 环境使用 react-i18next，纯 JS 环境使用轻量级实现
- **向后兼容**：保留常用 API 的别名导出

## 新架构设计

```
@sdppp/common/i18n/
├── locales/
│   ├── zh-CN.ts          # 中文翻译资源 (TypeScript)
│   ├── en-US.ts          # 英文翻译资源 (TypeScript) 
│   └── index.ts          # 类型定义和资源导出
├── vanilla.ts            # 纯 JavaScript 环境的 i18n API
├── react.ts              # React 环境的 i18n API (基于 react-i18next)
└── index.ts              # 统一入口和向后兼容性导出
```

## 使用方法

### 在纯 JavaScript 环境中使用（推荐用于 UXP 插件）

```typescript
import { t } from '@sdppp/common/i18n/vanilla'

// 基本用法
const loginText = t('auth.login_success')  // "登录成功" 或 "Login Successful"

// 带参数的翻译
const userText = t('auth.username_label', { username: 'John' })  // "用户名: John"

// 获取当前语言
import { getCurrentLanguage, isZhCN } from '@sdppp/common/i18n/vanilla'
console.log(getCurrentLanguage())  // "zh-CN" 或 "en-US"
console.log(isZhCN())  // true 或 false

// 手动切换语言
import { changeLanguage } from '@sdppp/common/i18n/vanilla'
changeLanguage('en-US')
```

### 在 React 组件中使用

```typescript
import { useTranslation } from '@sdppp/common/i18n/react'

function MyComponent() {
  const { t, changeLanguage, language, isZhCN } = useTranslation()
  
  return (
    <div>
      <h1>{t('auth.login_success')}</h1>
      <p>{t('auth.username_label', { username: 'John' })}</p>
      <button onClick={() => changeLanguage('en-US')}>
        Switch to English
      </button>
      <p>Current language: {language}</p>
    </div>
  )
}
```

### 在非组件 React 环境中使用

```typescript
import { t, changeLanguage, getCurrentLanguage } from '@sdppp/common/i18n/react'

// 在工具函数、中间件等地方使用
const message = t('common.loading')
await changeLanguage('zh-CN')
```

### 向后兼容的简化导入

```typescript
// 这些导入方式仍然可用，默认使用 vanilla 版本
import { t, getCurrentLanguage, isZhCN } from '@sdppp/common'
```

## 语言检测机制

系统采用统一的语言检测逻辑，按优先级顺序：

1. **浏览器环境**：检测 `navigator.language`
2. **UXP 环境**：检测 `require('uxp').host.uiLocale`
3. **默认值**：英文 (`en-US`)

```typescript
// 自动重新检测语言（仅 vanilla 版本支持）
import { redetectLanguage } from '@sdppp/common/i18n/vanilla'
redetectLanguage()
```

## 翻译资源结构

### 当前支持的翻译键

#### 认证相关
- `auth.login_success` - 登录成功
- `auth.username_label` - 用户名标签（支持参数 `{username}`）
- `auth.email_label` - 邮箱标签（支持参数 `{email}`）
- `auth.logout` - 退出登录
- `auth.login_required` - 登录提示

#### 图像处理相关
- `image.send.select_position` - 选择发送位置
- `image.send.sending` - 发送中状态
- `image.layer.new` - 新图层
- `image.layer.current` - 当前图层
- `image.layer.fit_to_*` - 适配选项
- `image.get.*` - 图像获取选项
- `image.crop.*` - 裁剪选项
- `image.shortcut_*` - 快捷键提示

#### 蒙版相关
- `mask.get.select_mask` - 选择蒙版
- `mask.selection` - 选区
- `mask.*_exclude` - 排除选项

#### 通用文案
- `common.close` - 关闭
- `common.cancel` - 取消
- `common.confirm` - 确认
- `common.loading` - 加载中
- `common.options` - 选项

### 添加新的翻译

1. 在 `locales/zh-CN.ts` 中添加中文翻译
2. 在 `locales/en-US.ts` 中添加对应的英文翻译
3. 确保键名一致，TypeScript 会自动提供类型检查

```typescript
// locales/zh-CN.ts
export const zhCN = {
  // 现有翻译...
  'feature.new_function': '新功能: {{name}}',
} as const

// locales/en-US.ts  
export const enUS = {
  // 现有翻译...
  'feature.new_function': 'New Feature: {{name}}',
} as const
```

## 参数替换

支持 `{{paramName}}` 格式的参数替换：

```typescript
// 翻译资源中
'welcome.message': 'Welcome {{username}}, you have {{count}} messages'

// 使用时
t('welcome.message', { username: 'John', count: 5 })
// 输出: "Welcome John, you have 5 messages"
```

## 类型安全

所有翻译键都有完整的 TypeScript 类型支持：

```typescript
import type { TranslationKey } from '@sdppp/common/i18n/locales'

// TranslationKey 联合类型包含所有有效的翻译键
const key: TranslationKey = 'auth.login_success'  // ✓ 有效
const invalid: TranslationKey = 'invalid.key'      // ✗ 类型错误
```

## 依赖关系

- **Vanilla 版本**：无外部依赖，纯 TypeScript 实现
- **React 版本**：依赖 `i18next` 和 `react-i18next`
- **共享依赖**：`@types/node`（仅开发时）

## 迁移指南

### 从旧版本迁移

1. **更新导入路径**：
   ```typescript
   // 旧版本
   import { tUXP } from '@sdppp/common/i18n_uxp'
   import { t } from '@sdppp/common/i18n_next'
   
   // 新版本
   import { t } from '@sdppp/common/i18n/vanilla'  // 用于非 React 环境
   import { useTranslation } from '@sdppp/common/i18n/react'  // 用于 React 组件
   ```

2. **参数格式变更**：
   ```typescript
   // 旧版本使用 {paramName}
   t('message', { name: 'John' })  // "Hello {name}" 
   
   // 新版本使用 {{paramName}}
   t('message', { name: 'John' })  // "Hello {{name}}"
   ```

3. **React 组件更新**：
   ```typescript
   // 旧版本
   import { t } from '@sdppp/common/i18n_utils'
   
   function Component() {
     return <div>{t('key')}</div>
   }
   
   // 新版本
   import { useTranslation } from '@sdppp/common/i18n/react'
   
   function Component() {
     const { t } = useTranslation()
     return <div>{t('key')}</div>
   }
   ```

## 最佳实践

1. **选择合适的 API**：
   - UXP 插件、工具函数：使用 `@sdppp/common/i18n/vanilla`
   - React 组件：使用 `@sdppp/common/i18n/react`

2. **翻译键命名规范**：
   - 使用点分隔的层级结构：`module.feature.action`
   - 保持键名简洁明了：`auth.login` 而不是 `authentication.user_login_action`

3. **参数使用**：
   - 优先使用参数替换而不是字符串拼接
   - 参数名使用 camelCase：`{{userName}}` 而不是 `{{user_name}}`

4. **类型安全**：
   - 始终导入 `TranslationKey` 类型以获得类型检查
   - 避免使用字符串字面量，让 TypeScript 自动推断

## 故障排除

### 常见问题

1. **翻译不生效**：
   - 检查翻译键是否在两个语言文件中都存在
   - 确认参数名称是否正确匹配

2. **类型错误**：
   - 确保使用的翻译键存在于类型定义中
   - 重新构建项目以更新类型缓存

3. **语言检测不准确**：
   - 在 UXP 环境中手动调用 `redetectLanguage()`
   - 检查系统语言设置

### 调试技巧

```typescript
// 获取当前所有翻译资源（仅 vanilla 版本）
import { getCurrentLanguage } from '@sdppp/common/i18n/vanilla'
console.log('Current language:', getCurrentLanguage())

// 检查特定键是否存在
const result = t('test.key')
if (result === 'test.key') {
  console.warn('Translation key not found:', 'test.key')
}
```

## 更新日志

### 2024-08-31 - v2.0.0 (重构版本)
- 🔄 完全重构架构，按技术栈分层
- 🔧 统一翻译资源格式（全部迁移到 TypeScript）
- ✨ 新增完整的类型安全支持
- 🗑️ 移除旧版本文件（`i18n_*.ts`）
- 📚 新增 React Hook 支持
- 🌐 完善语言检测逻辑
- 📝 新增完整的 PS-UXP 界面文案国际化

### 历史版本
- v1.x - 基于多文件的分散式架构
- 支持 JSON 和 TypeScript 混合资源格式
- 按运行环境区分 API